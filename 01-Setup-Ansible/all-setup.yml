# store in controller host '~/<this file>'

- name: "Install inventory mapping and setup all remote nodes"
  hosts: all
  become: true # newer ansible version of 'sudo'
  gather_facts: false # comment out if preferred
  pre_tasks:
  - name: "Add Ansible inventory mappings to /etc/hosts"
    blockinfile:
      path: '/etc/hosts'
      block: |
        {% for host in groups['all'] %}
        {{ hostvars[host].ansible_host }} {{ host }}
        {% endfor %}
  - name: "Install python"
    raw: 'cat < ~/python-remote-setup.sh'
    args:
      executable: '/bin/bash'

- name: "Remove swapfile for all hosts." # specific to kubernetes
  hosts: all
  become: true # newer ansible version of 'sudo'
  gather_facts: false # comment out if preferred
  tasks:
  - name: "Remove swapfile from /etc/fstab"
    mount:
      fstype: swap
      state: absent
  - name: "Disable swap permanently, persist reboots"
    replace:
      path: '/etc/fstab'
      regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
      replace: '#\1\2\3swap\4'
      backup: true

- name: "Copy and execute kubernetes setup script for each node."
  hosts: all
  become: true # newer ansible version of 'sudo'
  gather_facts: true # keeping true since this part can break, thanks kubernetes
  post_tasks:
    - name: "Execute kubernetes setup script."
      script: '~/kubernetes-ubuntu-setup.sh'
      register: console
    - debug: msg='{{ console.stdout }}'
    - debug: msg='{{ console.stderr }}' 